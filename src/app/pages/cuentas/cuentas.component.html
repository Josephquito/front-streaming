<div class="flex items-center gap-2 px-4">
  <!-- Botón fijo "Todas" -->
  <button
    class="btn shrink-0"
    [ngClass]="{
      'btn-primary': seleccionada === 'todas',
      'btn-outline': seleccionada !== 'todas'
    }"
    (click)="seleccionar('todas')"
  >
    Todas
  </button>

  <!-- Contenedor scroll solo para plataformas -->
  <div class="overflow-x-auto flex-1">
    <div class="inline-flex gap-2 py-4 whitespace-nowrap">
      <button
        *ngFor="let plataforma of plataformas"
        class="btn"
        #btnRef
        [ngClass]="{
          'btn-outline':
            !plataforma.color && seleccionada !== plataforma.nombre,
          'btn-primary': !plataforma.color && seleccionada === plataforma.nombre
        }"
        [ngStyle]="
          plataforma.color
            ? {
                'background-color': plataforma.color,
                color: '#fff',
                border:
                  seleccionada === plataforma.nombre ? '2px solid #000' : 'none'
              }
            : {}
        "
        (click)="seleccionar(plataforma.nombre, btnRef)"
      >
        {{ plataforma.nombre }}
      </button>
      <button
        class="btn shrink-0"
        (click)="seleccionar('inhabilitadas', inhaBtn)"
        #inhaBtn
      >
        Caidas
      </button>
    </div>
  </div>

  <!-- Botón fijo "Plataforma" -->
  <button class="btn btn-neutral" (click)="mostrarModal = true" *ngIf="isAdmin">
    +
  </button>
</div>

<hr />

<!-- Mensaje inferior -->
<div class="p-4 flex items-center justify-between">
  <p class="text-gray-500 italic">
    Mostrando cuentas de: <strong>{{ seleccionada }}</strong>
  </p>

  <!-- Botón de menú ⋮ -->
  <div class="relative" *ngIf="seleccionada !== 'todas'" #menuOpciones>
    <button
      class="text-gray-600 hover:text-black text-xl px-2"
      (click)="mostrarOpciones = !mostrarOpciones"
    >
      ⋮
    </button>

    <!-- Menú desplegable -->
    <div
      *ngIf="mostrarOpciones"
      class="absolute right-0 mt-2 w-40 bg-white shadow-md border rounded z-50"
    >
      <button
        class="block w-full text-left px-4 py-2 text-sm hover:bg-red-100 text-red-600"
        (click)="eliminarSeleccionada()"
      >
        Eliminar plataforma
      </button>
    </div>
  </div>
</div>

<div *ngIf="error" class="alert alert-error mt-2 text-sm">
  {{ error }}
</div>

<!-- Modal de creación -->
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  *ngIf="mostrarModal"
  (click)="cerrarModal()"
>
  <div
    class="bg-white p-6 rounded-lg w-full max-w-md shadow-lg"
    (click)="$event.stopPropagation()"
  >
    <h2 class="text-xl font-bold mb-4">Crear nueva plataforma</h2>

    <form (ngSubmit)="crearPlataforma()" #form="ngForm" class="space-y-4">
      <div>
        <label class="block font-semibold">Nombre:</label>
        <input
          [(ngModel)]="plataforma.nombre"
          name="nombre"
          required
          class="input input-bordered w-full"
        />
      </div>

      <div class="mb-4">
        <label class="block font-semibold mb-2">Color:</label>

        <div class="grid grid-cols-6 gap-1 justify-center">
          <button
            type="button"
            *ngFor="let c of colores"
            class="w-9 h-9 rounded-full border-2 transition-all"
            [ngStyle]="{
              'background-color': c.hex,
              'border-color': plataforma.color === c.hex ? '#000' : '#ccc',
              transform: plataforma.color === c.hex ? 'scale(1.1)' : 'scale(1)'
            }"
            (click)="plataforma.color = c.hex"
            [title]="c.nombre"
          ></button>
        </div>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" class="btn btn-outline" (click)="cerrarModal()">
          Cancelar
        </button>
        <button class="btn btn-primary" [disabled]="!form.valid">Crear</button>
      </div>
    </form>
  </div>
</div>

<!-- Fila buscador + botón -->
<div class="flex items-center gap-4 my-4 px-4">
  <!-- Buscador -->
  <label
    class="input input-bordered flex items-center gap-2 flex-grow max-w-md"
  >
    <svg
      class="w-5 h-5 text-gray-500"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <circle cx="11" cy="11" r="8" />
      <line x1="21" y1="21" x2="16.65" y2="16.65" />
    </svg>

    <input
      type="text"
      [(ngModel)]="busquedaGlobal"
      (input)="actualizarCuentasMostradas()"
      placeholder="Buscar correo..."
      class="grow"
    />
  </label>

  <!-- Botón a la derecha -->
  <button class="btn btn-neutral" (click)="abrirModalCuenta()">+ Cuenta</button>
</div>

<div class="p-4 relative z-0">
  <div class="overflow-x-auto">
    <table class="table w-full relative z-0">
      <thead>
        <tr class="bg-base-200 text-left text-sm">
          <th>#</th>
          <th>Servicio</th>
          <th>Usados</th>
          <th>Correo</th>
          <th>Clave</th>
          <th>Queda</th>
          <th>Mas</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let cuenta of cuentasMostradas; let i = index"
          class="cursor-pointer transition duration-150 ease-in-out hover:bg-base-200"
          [ngClass]="{ 'text-red-600': cuenta.inhabilitada }"
          (click)="verPerfiles(cuenta.id, $event)"
        >
          <!-- Número -->
          <td class="font-medium">{{ i + 1 }}</td>

          <!-- Plataforma -->
          <td
            class="uppercase font-semibold"
            [ngClass]="{ 'text-red-600': cuenta.inhabilitada }"
          >
            {{ cuenta.plataforma?.nombre
            }}<span *ngIf="cuenta.inhabilitada"> caída</span>
          </td>

          <!-- Perfiles usados -->
          <td>
            <span class="font-semibold text-gray-700">
              {{ cuenta.perfiles_usados }} /
              {{ cuenta.numero_perfiles }}
            </span>
          </td>

          <!-- Correo -->
          <td class="text-sm">{{ cuenta.correo }}</td>

          <!-- Clave -->
          <td class="text-sm">{{ cuenta.clave }}</td>

          <!-- Días restantes -->
          <td>
            <span
              class="font-semibold"
              [ngClass]="{
                'text-red-600': diasRestantes(cuenta.fecha_corte) <= 3,
                'text-yellow-600':
                  diasRestantes(cuenta.fecha_corte) > 3 &&
                  diasRestantes(cuenta.fecha_corte) <= 7,
                'text-green-600': diasRestantes(cuenta.fecha_corte) > 7
              }"
            >
              {{ diasRestantes(cuenta.fecha_corte) }} días
            </span>
          </td>

          <td class="text-right relative z-10">
            <div class="relative inline-block">
              <button
                class="btn btn-sm btn-ghost btn-circle"
                (click)="toggleDropdown($event, cuenta.id)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v.01M12 12v.01M12 18v.01"
                  />
                </svg>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Menú flotante global -->
<div
  *ngIf="dropdownAbierto !== null"
  class="fixed z-[9999] w-44 bg-white border rounded shadow-lg"
  [ngStyle]="{ top: dropdownPosY + 'px', left: dropdownPosX + 'px' }"
  (click)="$event.stopPropagation()"
>
  <button
    class="block w-full text-left px-4 py-2 hover:bg-gray-100"
    (click)="abrirModalRenovar(cuentaSeleccionada); cerrarDropdown()"
  >
    Renovar
  </button>
  <button
    class="block w-full text-left px-4 py-2 hover:bg-gray-100"
    (click)="abrirModalReemplazo(cuentaSeleccionada); cerrarDropdown()"
  >
    Reemplazar
  </button>
  <button
    *ngIf="!cuentaSeleccionada?.inhabilitada"
    class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600"
    (click)="inhabilitarCuenta(cuentaSeleccionada.id); cerrarDropdown()"
  >
    Inhabilitar
  </button>

  <button
    *ngIf="cuentaSeleccionada?.inhabilitada"
    class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-green-600"
    (click)="habilitarCuenta(cuentaSeleccionada.id); cerrarDropdown()"
  >
    Habilitar
  </button>

  <button
    *ngIf="isAdmin"
    class="block w-full text-left px-4 py-2 hover:bg-red-100 text-red-600"
    (click)="eliminarCuenta(cuentaSeleccionada?.id); cerrarDropdown()"
  >
    Eliminar
  </button>
</div>

<!-- Modal de cuenta -->
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"
  *ngIf="mostrarModalCuenta"
>
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h2 class="text-xl font-semibold mb-4">Agregar cuenta</h2>

    <div class="space-y-3">
      <!-- Correo -->
      <input
        [(ngModel)]="nuevaCuenta.correo"
        placeholder="Correo"
        class="input input-bordered w-full"
      />

      <!-- Clave -->
      <input
        [(ngModel)]="nuevaCuenta.clave"
        placeholder="Clave"
        class="input input-bordered w-full"
      />

      <!-- Fila: Costo - Proveedor -->
      <div class="flex gap-2">
        <input
          [(ngModel)]="nuevaCuenta.costo_total"
          type="number"
          placeholder="Costo $$"
          class="input input-bordered w-1/2"
        />
        <input
          [(ngModel)]="nuevaCuenta.proveedor"
          placeholder="Proveedor"
          class="input input-bordered w-1/2"
        />
      </div>

      <!-- Fila: Número de perfiles - Fecha -->
      <div class="flex gap-2">
        <div class="w-1/2">
          <label class="label">
            <span class="label-text">N° de perfiles</span>
          </label>
          <input
            [(ngModel)]="nuevaCuenta.numero_perfiles"
            type="number"
            placeholder="Ej: 5"
            class="input input-bordered w-full"
          />
        </div>

        <div class="w-1/2">
          <label class="label">
            <span class="label-text">Fecha de compra</span>
          </label>
          <input
            [(ngModel)]="nuevaCuenta.fecha_compra"
            type="date"
            class="input input-bordered w-full"
          />
        </div>
      </div>

      <!-- Tiempo asignado -->
      <input
        [(ngModel)]="nuevaCuenta.tiempo_asignado"
        placeholder="Tiempo Ej: 1 mes"
        class="input input-bordered w-full"
      />

      <!-- Selector de plataforma -->
      <select
        [(ngModel)]="nuevaCuenta.plataformaId"
        class="select select-bordered w-full"
      >
        <option [ngValue]="null" disabled selected>
          Selecciona plataforma
        </option>
        <option *ngFor="let plataforma of plataformas" [value]="plataforma.id">
          {{ plataforma.nombre }}
        </option>
      </select>
    </div>

    <div class="flex justify-end mt-4 space-x-2">
      <button class="btn btn-success" (click)="crearCuenta()">Guardar</button>
      <button class="btn btn-outline" (click)="cerrarModalCuenta()">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Reemplazo -->
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"
  *ngIf="mostrarModalReemplazo"
>
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h2 class="text-xl font-semibold mb-4">Reemplazar cuenta</h2>

    <div class="space-y-3">
      <!-- Correo -->
      <input
        [(ngModel)]="cuentaReemplazo.correo"
        placeholder="Correo"
        class="input input-bordered w-full"
      />

      <!-- Clave -->
      <input
        [(ngModel)]="cuentaReemplazo.clave"
        placeholder="Clave"
        class="input input-bordered w-full"
      />

      <!-- Costo - Proveedor -->
      <div class="flex gap-2">
        <input
          [(ngModel)]="cuentaReemplazo.costo_total"
          type="number"
          placeholder="Costo $$"
          class="input input-bordered w-1/2"
        />
        <input
          [(ngModel)]="cuentaReemplazo.proveedor"
          placeholder="Proveedor"
          class="input input-bordered w-1/2"
          disabled
        />
      </div>

      <!-- Fecha compra -->
      <input
        [(ngModel)]="cuentaReemplazo.fecha_compra"
        type="date"
        class="input input-bordered w-full"
      />

      <!-- Tiempo asignado -->
      <input
        [(ngModel)]="cuentaReemplazo.tiempo_asignado"
        placeholder="Tiempo asignado (ej: 1 mes)"
        class="input input-bordered w-full"
      />
    </div>

    <div class="flex justify-end mt-4 gap-2">
      <button class="btn btn-ghost" (click)="cerrarModalReemplazo()">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="guardarReemplazo()">
        Guardar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Renovación -->
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"
  *ngIf="mostrarModalRenovar"
>
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h2 class="text-xl font-semibold mb-4">Renovar cuenta</h2>

    <div class="space-y-3">
      <input
        [(ngModel)]="cuentaRenovar.fecha_compra"
        type="date"
        class="input input-bordered w-full"
        placeholder="Fecha de compra"
      />
      <input
        [(ngModel)]="cuentaRenovar.costo_total"
        type="number"
        placeholder="Costo total"
        class="input input-bordered w-full"
      />
      <input
        [(ngModel)]="cuentaRenovar.tiempo_asignado"
        placeholder="Tiempo asignado (ej: 1 mes)"
        class="input input-bordered w-full"
      />
    </div>

    <div class="flex justify-end mt-4 gap-2">
      <button class="btn btn-ghost" (click)="cerrarModalRenovar()">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="guardarRenovacion()">
        Guardar
      </button>
    </div>
  </div>
</div>
