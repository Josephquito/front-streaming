<div class="flex items-center gap-2 px-4">
  <!-- Bot√≥n fijo "Todas" -->
  <button
    class="btn shrink-0"
    [ngClass]="{
      'btn-primary': seleccionada === 'todas',
      'btn-outline': seleccionada !== 'todas'
    }"
    (click)="seleccionar('todas')"
  >
    Todas
  </button>

  <!-- Contenedor scroll solo para plataformas -->
  <div class="overflow-x-auto flex-1">
    <div class="inline-flex gap-2 py-4 whitespace-nowrap">
      <button
        *ngFor="let plataforma of plataformas"
        class="btn"
        #btnRef
        [ngClass]="{
          'btn-outline':
            !plataforma.color && seleccionada !== plataforma.nombre,
          'btn-primary': !plataforma.color && seleccionada === plataforma.nombre
        }"
        [ngStyle]="
          plataforma.color
            ? {
                'background-color': plataforma.color,
                color: '#fff',
                border:
                  seleccionada === plataforma.nombre ? '2px solid #000' : 'none'
              }
            : {}
        "
        (click)="seleccionar(plataforma.nombre, btnRef)"
      >
        {{ plataforma.nombre }}
      </button>
    </div>
  </div>

  <!-- Bot√≥n fijo "Plataforma" -->
  <button class="btn btn-neutral" (click)="mostrarModal = true" *ngIf="isAdmin">
    +
  </button>
</div>

<hr />

<!-- Mensaje inferior -->
<div class="p-4 flex items-center justify-between">
  <p class="text-gray-500 italic">
    Mostrando cuentas de: <strong>{{ seleccionada }}</strong>
  </p>

  <!-- Bot√≥n de men√∫ ‚ãÆ -->
  <div class="relative" *ngIf="seleccionada !== 'todas'" #menuOpciones>
    <button
      class="text-gray-600 hover:text-black text-xl px-2"
      (click)="mostrarOpciones = !mostrarOpciones"
    >
      ‚ãÆ
    </button>

    <!-- Men√∫ desplegable -->
    <div
      *ngIf="mostrarOpciones"
      class="absolute right-0 mt-2 w-40 bg-white shadow-md border rounded z-50"
    >
      <button
        class="block w-full text-left px-4 py-2 text-sm hover:bg-red-100 text-red-600"
        (click)="eliminarSeleccionada()"
      >
        Eliminar plataforma
      </button>
    </div>
  </div>
</div>

<div *ngIf="error" class="alert alert-error mt-2 text-sm">
  {{ error }}
</div>

<!-- Modal de creaci√≥n -->
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  *ngIf="mostrarModal"
  (click)="cerrarModal()"
>
  <div
    class="bg-white p-6 rounded-lg w-full max-w-md shadow-lg"
    (click)="$event.stopPropagation()"
  >
    <h2 class="text-xl font-bold mb-4">Crear nueva plataforma</h2>

    <form (ngSubmit)="crearPlataforma()" #form="ngForm" class="space-y-4">
      <div>
        <label class="block font-semibold">Nombre:</label>
        <input
          [(ngModel)]="plataforma.nombre"
          name="nombre"
          required
          class="input input-bordered w-full"
        />
      </div>

      <div class="mb-4">
        <label class="block font-semibold mb-2">Color:</label>

        <div class="grid grid-cols-6 gap-1 justify-center">
          <button
            type="button"
            *ngFor="let c of colores"
            class="w-9 h-9 rounded-full border-2 transition-all"
            [ngStyle]="{
              'background-color': c.hex,
              'border-color': plataforma.color === c.hex ? '#000' : '#ccc',
              transform: plataforma.color === c.hex ? 'scale(1.1)' : 'scale(1)'
            }"
            (click)="plataforma.color = c.hex"
            [title]="c.nombre"
          ></button>
        </div>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" class="btn btn-outline" (click)="cerrarModal()">
          Cancelar
        </button>
        <button class="btn btn-primary" [disabled]="!form.valid">Crear</button>
      </div>
    </form>
  </div>
</div>

<!-- Fila buscador + bot√≥n -->
<div class="flex items-center gap-4 my-4 px-4">
  <!-- Buscador -->
  <label
    class="input input-bordered flex items-center gap-2 flex-grow max-w-md"
  >
    <svg
      class="w-5 h-5 text-gray-500"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <circle cx="11" cy="11" r="8" />
      <line x1="21" y1="21" x2="16.65" y2="16.65" />
    </svg>

    <input
      type="text"
      [(ngModel)]="busquedaGlobal"
      (input)="actualizarCuentasMostradas()"
      placeholder="Buscar correo..."
      class="grow"
    />
  </label>

  <!-- Bot√≥n a la derecha -->
  <button class="btn btn-neutral" (click)="abrirModalCuenta()">+ Cuenta</button>
</div>

<div class="p-4 overflow-x-auto">
  <table class="table w-full">
    <thead>
      <tr class="bg-gray-100 text-left">
        <th>Queda</th>
        <th>Correo</th>
        <th>Clave</th>
        <th>Usados</th>
        <th>Costo</th>
        <th>Proveedor</th>
        <th>Compra</th>
        <th>Tiempo</th>
        <th>Corte</th>
        <th>Acciones</th>
        <th>Servicio</th>
        <th>#</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let cuenta of cuentasMostradas; let i = index"
        class="hover:bg-gray-50 cursor-pointer"
        (click)="verPerfiles(cuenta.id, $event)"
      >
        <td>
          <span
            [ngClass]="{
              'text-red-600 font-bold': diasRestantes(cuenta.fecha_corte) <= 3,
              'text-yellow-600':
                diasRestantes(cuenta.fecha_corte) > 3 &&
                diasRestantes(cuenta.fecha_corte) <= 7,
              'text-green-600': diasRestantes(cuenta.fecha_corte) > 7
            }"
          >
            {{ diasRestantes(cuenta.fecha_corte) }} d√≠as
          </span>
        </td>

        <td>{{ cuenta.correo }}</td>

        <!-- Clave editable -->
        <td>
          <ng-container *ngIf="editandoId === cuenta.id; else claveTexto">
            <input
              [(ngModel)]="cuenta.clave"
              class="input input-sm w-full"
              (blur)="guardarCambios(cuenta)"
              (keydown.enter)="guardarCambios(cuenta)"
            />
          </ng-container>
          <ng-template #claveTexto>{{ cuenta.clave }}</ng-template>
        </td>

        <!-- Usados / Total de perfiles -->
        <td>
          {{ cuenta.perfiles_usados }} de
          <ng-container *ngIf="editandoId === cuenta.id; else textoPerfiles">
            <input
              type="number"
              [(ngModel)]="cuenta.numero_perfiles"
              class="input input-sm w-16 inline-block text-right"
              (blur)="guardarCambios(cuenta)"
              (keydown.enter)="guardarCambios(cuenta)"
              min="1"
            />
          </ng-container>
          <ng-template #textoPerfiles>{{ cuenta.numero_perfiles }}</ng-template>
        </td>

        <!-- Costo editable -->
        <td>
          <ng-container *ngIf="editandoId === cuenta.id; else costoTexto">
            <input
              type="number"
              [(ngModel)]="cuenta.costo_total"
              class="input input-sm w-full"
              (blur)="guardarCambios(cuenta)"
              (keydown.enter)="guardarCambios(cuenta)"
            />
          </ng-container>
          <ng-template #costoTexto>$ {{ cuenta.costo_total }}</ng-template>
        </td>

        <td>{{ cuenta.proveedor }}</td>

        <!-- Compra editable -->
        <td>
          <ng-container *ngIf="editandoId === cuenta.id; else compraTexto">
            <input
              type="date"
              [(ngModel)]="cuenta.fecha_compra"
              class="input input-sm w-full"
              (blur)="guardarCambios(cuenta)"
              (keydown.enter)="guardarCambios(cuenta)"
            />
          </ng-container>
          <ng-template #compraTexto>
            {{ cuenta.fecha_compra | date : "shortDate" }}
          </ng-template>
        </td>

        <!-- Tiempo asignado editable -->
        <td>
          <ng-container *ngIf="editandoId === cuenta.id; else tiempoTexto">
            <input
              [(ngModel)]="cuenta.tiempo_asignado"
              class="input input-sm w-full"
              (blur)="guardarCambios(cuenta)"
              (keydown.enter)="guardarCambios(cuenta)"
            />
          </ng-container>
          <ng-template #tiempoTexto>{{ cuenta.tiempo_asignado }}</ng-template>
        </td>

        <td>{{ cuenta.fecha_corte | date : "shortDate" }}</td>

        <!-- Acciones -->
        <td class="whitespace-nowrap space-x-1">
          <ng-container *ngIf="editandoId === cuenta.id; else botonesNormales">
            <button
              class="btn btn-sm btn-success"
              (click)="guardarCambios(cuenta); $event.stopPropagation()"
              title="Guardar"
            >
              üíæ
            </button>
            <button
              class="btn btn-sm btn-outline"
              (click)="cancelarEdicion(); $event.stopPropagation()"
              title="Cancelar"
            >
              ‚ùå
            </button>
          </ng-container>
          <ng-template #botonesNormales>
            <button
              class="btn btn-sm btn-outline"
              (click)="iniciarEdicion(cuenta.id); $event.stopPropagation()"
              title="Editar"
            >
              ‚úèÔ∏è
            </button>
            <button
              class="btn btn-sm btn-outline text-red-600"
              (click)="eliminarCuenta(cuenta.id); $event.stopPropagation()"
              title="Eliminar"
              *ngIf="isAdmin"
            >
              üóëÔ∏è
            </button>
          </ng-template>
        </td>
        <td>{{ cuenta.plataforma?.nombre || "‚Äî" }}</td>
        <td>{{ i + 1 }}</td>
      </tr>
    </tbody>
  </table>

  <!-- Modal de cuenta -->
  <div
    class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"
    *ngIf="mostrarModalCuenta"
  >
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
      <h2 class="text-xl font-semibold mb-4">Agregar cuenta</h2>

      <div class="space-y-3">
        <!-- Correo -->
        <input
          [(ngModel)]="nuevaCuenta.correo"
          placeholder="Correo"
          class="input input-bordered w-full"
        />

        <!-- Clave -->
        <input
          [(ngModel)]="nuevaCuenta.clave"
          placeholder="Clave"
          class="input input-bordered w-full"
        />

        <!-- Fila: Costo - Proveedor -->
        <div class="flex gap-2">
          <input
            [(ngModel)]="nuevaCuenta.costo_total"
            type="number"
            placeholder="Costo $$"
            class="input input-bordered w-1/2"
          />
          <input
            [(ngModel)]="nuevaCuenta.proveedor"
            placeholder="Proveedor"
            class="input input-bordered w-1/2"
          />
        </div>

        <!-- Fila: N√∫mero de perfiles - Fecha -->
        <div class="flex gap-2">
          <div class="w-1/2">
            <label class="label">
              <span class="label-text">N¬∞ de perfiles</span>
            </label>
            <input
              [(ngModel)]="nuevaCuenta.numero_perfiles"
              type="number"
              placeholder="Ej: 5"
              class="input input-bordered w-full"
            />
          </div>

          <div class="w-1/2">
            <label class="label">
              <span class="label-text">Fecha de compra</span>
            </label>
            <input
              [(ngModel)]="nuevaCuenta.fecha_compra"
              type="date"
              class="input input-bordered w-full"
            />
          </div>
        </div>

        <!-- Tiempo asignado -->
        <input
          [(ngModel)]="nuevaCuenta.tiempo_asignado"
          placeholder="Ej: 2 meses, 15 d√≠as"
          class="input input-bordered w-full"
        />

        <!-- Selector de plataforma -->
        <select
          [(ngModel)]="nuevaCuenta.plataformaId"
          class="select select-bordered w-full"
        >
          <option [ngValue]="null" disabled selected>
            Selecciona plataforma
          </option>
          <option
            *ngFor="let plataforma of plataformas"
            [value]="plataforma.id"
          >
            {{ plataforma.nombre }}
          </option>
        </select>
      </div>

      <div class="flex justify-end mt-4 space-x-2">
        <button class="btn btn-success" (click)="crearCuenta()">Guardar</button>
        <button class="btn btn-outline" (click)="cerrarModalCuenta()">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
