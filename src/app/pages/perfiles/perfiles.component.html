<div class="p-4">
  <div class="flex justify-between items-center mb-4">
    <button class="btn btn-sm btn-outline" (click)="volverAtras()">
      ‚¨ÖÔ∏è Regresar
    </button>
  </div>

  <!-- üîí Detalles completos de la cuenta solo para admins -->
  <div class="border rounded-lg p-4 mb-6 bg-base-100 shadow">
    <h3 class="text-lg font-semibold mb-2">
      {{ cuentaSeleccionada.plataforma?.nombre | uppercase }}:
      {{ cuentaSeleccionada.correo }}
    </h3>

    <!-- Tabla de perfiles (estilo igual al m√≥dulo de cuentas) -->
    <div class="overflow-x-auto">
      <table class="table w-full relative z-0">
        <thead>
          <tr class="bg-base-200 text-left text-sm">
            <th>Perfil</th>
            <th>Cliente</th>
            <th>Queda</th>
            <th>Fecha venta</th>
            <th>Tiempo</th>
            <th>Corte</th>
            <th>Precio</th>
            <th class="text-right">M√°s</th>
          </tr>
        </thead>

        <tbody>
          <!-- Una sola lista de slots fijos -->
          <tr
            *ngFor="let slot of slots"
            class="cursor-pointer transition duration-150 ease-in-out hover:bg-base-200"
          >
            <!-- N√∫mero fijo -->
            <td class="font-medium">P{{ slot.pos }}</td>

            <!-- Si el slot tiene perfil -->
            <ng-container *ngIf="slot.perfil; else slotVacio">
              <td class="uppercase font-semibold">
                {{ slot.perfil?.cliente?.nombre || "‚Äî" }}
              </td>

              <td>
                <span
                  class="font-semibold"
                  [ngClass]="{
                    'text-gray-400':
                      !slot.perfil?.fecha_corte ||
                      slot.perfil?.activo === false,
                    'text-red-600':
                      diasRestantes(slot.perfil?.fecha_corte) <= 3 &&
                      slot.perfil?.activo !== false,
                    'text-yellow-600':
                      diasRestantes(slot.perfil?.fecha_corte) > 3 &&
                      diasRestantes(slot.perfil?.fecha_corte) <= 7 &&
                      slot.perfil?.activo !== false,
                    'text-green-600':
                      diasRestantes(slot.perfil?.fecha_corte) > 7 &&
                      slot.perfil?.activo !== false
                  }"
                >
                  {{
                    slot.perfil?.activo === false || !slot.perfil?.fecha_corte
                      ? "‚Äî"
                      : diasRestantes(slot.perfil?.fecha_corte) + " d√≠as"
                  }}
                </span>
              </td>

              <td>{{ slot.perfil?.fecha_venta || "‚Äî" }}</td>
              <td>{{ slot.perfil?.tiempo_asignado || "‚Äî" }}</td>
              <td>{{ slot.perfil?.fecha_corte || "‚Äî" }}</td>

              <td>
                {{
                  slot.perfil?.precio != null
                    ? "$" + (slot.perfil?.precio | number : "1.2-2")
                    : "‚Äî"
                }}
              </td>

              <td class="text-right relative z-10">
                <button
                  class="btn btn-sm btn-ghost btn-circle"
                  (click)="
                    toggleDropdownPerfil($event, slot.perfil.id, slot.perfil)
                  "
                >
                  ‚ãÆ
                </button>
              </td>
            </ng-container>

            <!-- Si el slot est√° vac√≠o -->
            <ng-template #slotVacio>
              <td class="text-gray-400">‚Äî</td>
              <td class="text-gray-400">‚Äî</td>
              <td class="text-gray-400">‚Äî</td>
              <td class="text-gray-400">‚Äî</td>
              <td class="text-gray-400">‚Äî</td>
              <td class="text-gray-400">‚Äî</td>
              <td class="text-right">
                <button
                  class="btn btn-sm btn-outline btn-accent"
                  (click)="abrirModalVenderEnSlot(slot.pos)"
                >
                  + Vender
                </button>
              </td>
            </ng-template>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Men√∫ flotante para perfiles -->
    <div
      #menuPerfil
      *ngIf="dropdownPerfilAbierto !== null"
      class="fixed z-[9999] w-44 bg-white border rounded shadow-lg"
      [ngStyle]="{
        top: dropdownPerfilPosY + 'px',
        left: dropdownPerfilPosX + 'px'
      }"
      (click)="$event.stopPropagation()"
    >
      <button
        class="block w-full text-left px-4 py-2 hover:bg-gray-100"
        (click)="iniciarEdicion(selectedPerfil?.id); cerrarDropdownPerfil()"
      >
        Editar
      </button>

      <button
        *ngIf="selectedPerfil?.activo !== false"
        class="block w-full text-left px-4 py-2 hover:bg-gray-100"
        (click)="eliminarPerfil(selectedPerfil?.id); cerrarDropdownPerfil()"
      >
        Vaciar
      </button>

      <button
        *ngIf="selectedPerfil?.cliente"
        class="block w-full text-left px-4 py-2 hover:bg-gray-100"
        (click)="
          copiarPlantilla(selectedPerfil, perfiles.indexOf(selectedPerfil));
          cerrarDropdownPerfil()
        "
      >
        Copiar
      </button>
    </div>

    <!-- Modal de venta de perfil -->
    <div
      *ngIf="mostrarModalVender"
      class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
    >
      <div
        class="bg-white dark:bg-base-100 p-6 rounded-lg shadow-md w-full max-w-md"
      >
        <h2 class="text-lg font-semibold mb-4">Vender Perfil</h2>

        <div class="grid grid-cols-1 gap-4">
          <div class="relative w-full">
            <input
              type="text"
              class="input input-bordered w-full"
              placeholder="Cliente (nombre o numero)"
              [(ngModel)]="busquedaCliente"
              (input)="filtrarClientes()"
              (focus)="mostrarListaClientes = true"
              (blur)="ocultarListaClientes()"
            />

            <ul
              *ngIf="mostrarListaClientes && clientesFiltrados.length > 0"
              class="absolute z-50 bg-white border w-full max-h-48 overflow-y-auto rounded shadow"
            >
              <li
                *ngFor="let cliente of clientesFiltrados.slice(0, 2)"
                (mousedown)="seleccionarCliente(cliente)"
                class="p-2 hover:bg-gray-100 cursor-pointer"
              >
                {{ cliente.nombre }} ({{ cliente.contacto || "sin n√∫mero" }})
              </li>
              <!-- ‚úÖ bien cerrado -->
            </ul>
            <!-- ‚úÖ bien cerrado -->
          </div>
          <!-- ‚úÖ bien cerrado -->

          <input
            type="date"
            class="input input-bordered w-full"
            [(ngModel)]="nuevoPerfil.fecha_venta"
          />
          <label class="block text-sm font-medium mb-2">Tiempo asignado</label>

          <div class="flex flex-wrap items-center gap-2">
            <!-- Botones preset (mismo dise√±o) -->
            <div class="btn-group">
              <button
                type="button"
                class="btn btn-sm"
                [class.btn-active]="tiempoPresetPerfil === '1m'"
                (click)="setPresetPerfil('1m')"
              >
                1 mes
              </button>

              <button
                type="button"
                class="btn btn-sm"
                [class.btn-active]="tiempoPresetPerfil === '3m'"
                (click)="setPresetPerfil('3m')"
              >
                3 meses
              </button>

              <button
                type="button"
                class="btn btn-sm"
                [class.btn-active]="tiempoPresetPerfil === '6m'"
                (click)="setPresetPerfil('6m')"
              >
                6 meses
              </button>
            </div>

            <!-- N d√≠as: si escribes, sobreescribe lo anterior -->
            <div class="flex items-center gap-2">
              <input
                type="number"
                min="1"
                class="input input-sm input-bordered w-28"
                placeholder="N d√≠as"
                [(ngModel)]="customDiasPerfil"
                (focus)="tiempoPresetPerfil = null"
                (ngModelChange)="onCustomDiasChangePerfil()"
              />
              <span class="text-sm">d√≠as</span>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-2">
            Se enviar√°:
            <span class="font-semibold">{{
              nuevoPerfil.tiempo_asignado || "‚Äî"
            }}</span>
          </p>

          <input
            type="number"
            class="input input-bordered w-full"
            [(ngModel)]="nuevoPerfil.precio"
            placeholder="Precio Venta"
          />
        </div>

        <div class="flex justify-end mt-4 gap-2">
          <button class="btn btn-sm btn-success" (click)="registrarPerfil()">
            Guardar
          </button>
          <button class="btn btn-sm btn-outline" (click)="cerrarModal()">
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
